<!DOCTYPE html>
<html lang="de-CH">
  <head>
    <meta charset="UTF-8" />
    <title>Zeitmessung</title>
  </head>
  <body>
    <style>
      body {
        font-family: Roobert, -apple-system, BlinkMacSystemFont, "Segoe UI",
          Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji",
          "Segoe UI Symbol";
      }
      .big-button {
        appearance: none;
        background-color: transparent;
        border: 2px solid #1a1a1a;
        border-radius: 15px;
        box-sizing: border-box;
        color: #3b3b3b;
        cursor: pointer;
        display: inline-block;

        font-size: 16px;
        font-weight: 600;
        line-height: normal;
        margin: 5px;
        min-height: 30px;
        min-width: 0;
        outline: none;
        padding: 10px 16px;
        text-align: center;
        text-decoration: none;
        transition: all 300ms cubic-bezier(0.23, 1, 0.32, 1);
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
        will-change: transform;
      }

      .big-button:disabled {
        pointer-events: none;
      }

      .big-button:hover {
        color: #fff;
        background-color: #1a1a1a;
        box-shadow: rgba(0, 0, 0, 0.25) 0 8px 15px;
        transform: translateY(-2px);
      }

      .big-button:active {
        box-shadow: none;
        transform: translateY(0);
      }

      :root {
        --input-border: #8b8a8b;
        --input-focus-h: 245;
        --input-focus-s: 100%;
        --input-focus-l: 42%;
      }

      input {
        font-size: 16px;
        font-size: max(16px, 1em);
        font-family: inherit;
        padding: 0.25em 0.5em;
        background-color: #fff;
        border: 2px solid var(--input-border);
        border-radius: 4px;
      }

      .container-row {
        display: flex;
      }
      button {
        margin: 10px;
      }
      div {
        margin: 10px;
      }

      /* The snackbar - position it at the bottom and in the middle of the screen */
      #snackbar {
        visibility: hidden; /* Hidden by default. Visible on click */
        min-width: 250px; /* Set a default minimum width */
        margin-left: -125px; /* Divide value of min-width by 2 */
        background-color: rgb(255, 0, 0); /* red background color */
        color: #fff; /* White text color */
        text-align: center; /* Centered text */
        border-radius: 10px; /* Rounded borders */
        padding: 16px; /* Padding */
        position: fixed; /* Sit on at the bottom of the screen */
        z-index: 10; /* Add a z-index if needed */
        left: 50%; /* Center the snackbar */
        bottom: 30px; /* 30px from the bottom */
      }

      /* Show the snackbar when clicking on a button (class added with JavaScript) */
      #snackbar.show {
        visibility: visible; /* Show the snackbar */
        /* Add animation: Take 0.5 seconds to fade in and out the snackbar.
      However, delay the fade out process for 2.5 seconds */
        -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
        animation: fadein 0.5s, fadeout 0.5s 2.5s;
      }

      /* Animations to fade the snackbar in and out */
      @-webkit-keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @keyframes fadein {
        from {
          bottom: 0;
          opacity: 0;
        }
        to {
          bottom: 30px;
          opacity: 1;
        }
      }

      @-webkit-keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }

      @keyframes fadeout {
        from {
          bottom: 30px;
          opacity: 1;
        }
        to {
          bottom: 0;
          opacity: 0;
        }
      }
    </style>
    <script>
      let _entries = [];
      let _measurementLocation;

      function createTableRow(rowNumber, table, numberPlateValue, nameValue) {
        const tableRow = table.insertRow();
        const numberPlate = tableRow.insertCell();
        numberPlate.innerText = numberPlateValue;
        tableRow.appendChild(numberPlate);
        var name = document.createElement("td");
        name.className = "name-field";
        name.innerText = nameValue;
        tableRow.appendChild(name);
        return tableRow;
      }

      function createButton(rowNumber, tableRow, label) {
        let button = document.getElementById(`button-${rowNumber}`);
        if (!button) {
          button = document.createElement("button");
          button.id = `button-${rowNumber}`;
          button.onclick = function () {
            const rowNumber = parseInt(this.id.match(/\d+/g)[0]);
            addTimestamp(rowNumber);
          };
          button.innerText = `${label} ${rowNumber + 1}`;
          let tableData = tableRow.insertCell();
          tableData.appendChild(button);
          return button;
        }
      }

      function createDisplay(rowNumber, tableRow) {
        let display = document.getElementById(`timestamp-${rowNumber}`);

        if (!display) {
          display = document.createElement("input");
          display.setAttribute("type", "text");
          display.id = `timestamp-${rowNumber}`;
          display.onchange = function () {
            try {
              const rowNumber = parseInt(this.id.match(/\d+/g)[0]);
              if (display.value)
                _entries[rowNumber].time = parseTime(display.value);
              else delete _entries[rowNumber].time;
              saveEntries();
            } catch (error) {
              delete _entries[rowNumber].time;
              display.value = "";
            }
          };
        }
        let tableData = tableRow.insertCell();
        tableData.appendChild(display);
        return display;
      }

      function parseTime(t) {
        var d = new Date();
        var time = t.match(/(\d{1,2})(?:[:|.](\d{1,2}))?(?:[:|.](\d{1,2}))?/);
        d.setHours(parseInt(time[1]));
        d.setMinutes(parseInt(time[2]) || 0);
        d.setSeconds(parseInt(time[3]) || 0);
        return d;
      }

      function addTimestamp(rowNumber) {
        let display = document.getElementById(`timestamp-${rowNumber}`);
        _entries[rowNumber].time = new Date();
        display.value = formatDateToTimeString(_entries[rowNumber].time);
        saveEntries();
      }

      function saveEntries() {
        localStorage.setItem(
          `measurement-${_measurementLocation}`,
          JSON.stringify(_entries)
        );
      }

      function clearEntries() {
        _entries = [];
        localStorage.removeItem(`measurement-${_measurementLocation}`);
      }

      function loadFromStorage() {
        _measurementLocation = document.getElementById(
          "select-measurement-location"
        ).value;
        load(
          JSON.parse(
            localStorage.getItem(`measurement-${_measurementLocation}`)
          )
        );
      }

      function loadFromFile() {
        _measurementLocation = document.getElementById(
          "select-measurement-location"
        ).value;
        clearEntries();
        Array.from(document.getElementById("load-file").files)[0]
          .text()
          .then((text) => {
            load(JSON.parse(text));
            saveEntries();
          });
      }

      function load(entries) {
        if (!validate(entries)) return;

        entries.forEach((e) => delete e.isSpare);
        _entries = entries;
        if (!_entries) return;

        const container = document.getElementById("container");
        container.innerHTML = "";
        const table = document.createElement("table");
        addHeader(table);
        const tableBody = table.createTBody();
        for (let i = 0; i < _entries.length; i++) {
          let tableRow = createTableRow(
            i,
            tableBody,
            _entries[i].numberPlate,
            _entries[i].name
          );
          createButton(i, tableRow, _measurementLocation);
          let display = createDisplay(i, tableRow);
          if (_entries[i].time) {
            display.value = formatDateToTimeString(
              Date.parse(_entries[i].time)
            );
          }
        }
        container.appendChild(table);
      }

      function addHeader(table) {
        var headerRow = table.createTHead().insertRow();
        for (header of ["Nr.", "Name", "", "Zeit"]) {
          let cell = headerRow.insertCell();
          cell.innerText = header;
        }
      }

      function validate(entries) {
        if (!(entries instanceof Array)) {
          console.log("participants is not an array");
          return false;
        }
        if (!entries.every((p) => "numberPlate" in p && "name" in p)) {
          showSnackbar("Falsches Datenformat");
          return false;
        }
        return true;
      }

      function reset() {
        _entries = [];
        const container = document.getElementById("container");
        container.innerHTML = "";
        document.getElementById("load-file").value = "";
      }
      function exportMeasurements() {
        var dataStr =
          "data:text/json;charset=utf-8," +
          encodeURIComponent(JSON.stringify(_entries));
        var dlAnchorElem = document.getElementById("downloadAnchorElem");
        dlAnchorElem.setAttribute("href", dataStr);
        dlAnchorElem.setAttribute(
          "download",
          `${_measurementLocation}_${Date.now()}.json`
        );
        dlAnchorElem.click();
      }

      function formatDateToTimeString(date) {
        const dateOptions = {
          timeZone: "Europe/Zurich",
          hour: "numeric",
          minute: "numeric",
          second: "numeric",
        };

        const dateFormatter = new Intl.DateTimeFormat("de-CH", dateOptions);
        return dateFormatter.format(date);
      }

      function showSnackbar(text) {
        var snackbar = document.getElementById("snackbar");
        snackbar.innerText = text;

        snackbar.className = "show";

        setTimeout(function () {
          snackbar.className = snackbar.className.replace("show", "");
        }, 3000);
      }
    </script>

    <label for="select-measurement-location">Messort:</label>
    <select
      id="select-measurement-location"
      class="big-select"
      onchange="reset()"
    >
      <option>Start</option>
      <option>Ziel</option>
    </select>

    <br />
    <label for="load-file">Lade Startliste:</label>
    <input
      type="file"
      id="load-file"
      accept=".json"
      onchange="loadFromFile()"
    />

    <button
      type="button"
      id="load-measurements"
      class="big-button"
      onclick="loadFromStorage()"
    >
      Load
    </button>
    <a id="downloadAnchorElem" style="display: none"></a>

    <button
      type="button"
      id="export-measurements"
      class="big-button"
      onclick="exportMeasurements()"
    >
      Export
    </button>
    <div id="container"></div>

    <div id="snackbar">Some text some message..</div>
  </body>
</html>
